# 民泊・ゲストハウス予約サービス

## プロジェクト概要

民泊やゲストハウスなど、ホテル以外の宿泊施設専用の予約サービスプラットフォーム。

### 主要機能

#### 1. 一般利用者向けサービス
- 宿泊施設の検索・閲覧
- 宿泊施設の予約
- 予約履歴の確認
- ユーザープロフィール管理
- レビュー・評価投稿

#### 2. 施設オーナー向け管理画面
- 自社施設の登録・編集
- 施設の空き枠管理
- 予約状況の確認
- 予約の承認・キャンセル
- 施設のレビュー確認

#### 3. サービス管理者向け管理画面
- 施設オーナーアカウント管理
- 一般利用者アカウント管理
- 施設の承認・審査
- プラットフォーム全体の統計表示
- システム設定管理

## システム構成

```
┌─────────────────────────────────────────────────────────┐
│                     フロントエンド層                      │
├─────────────────────────────────────────────────────────┤
│  一般利用者向けアプリ  │  オーナー向け管理画面  │  管理者向け管理画面  │
│  (Guest Frontend)      │  (Owner Dashboard)    │  (Admin Dashboard)    │
└──────────┬──────────────┴───────────┬─────────┴──────────┬──────────┘
           │                          │                     │
           └──────────────┬───────────┴─────────────────────┘
                          │
                ┌─────────▼─────────┐
                │    API Gateway     │
                │  (RESTful API)     │
                └─────────┬─────────┘
                          │
                ┌─────────▼─────────┐
                │  バックエンド層    │
                │ (Business Logic)   │
                └─────────┬─────────┘
                          │
                ┌─────────▼─────────┐
                │   データベース層   │
                │   (PostgreSQL)     │
                └───────────────────┘
```

## ディレクトリ構成

```
booking/
├── docs/                           # 設計ドキュメント
│   ├── architecture/               # アーキテクチャ設計
│   ├── api/                        # API仕様
│   ├── database/                   # データベース設計
│   └── ui/                         # UI設計
├── backend/                        # バックエンドアプリケーション
│   ├── src/
│   │   ├── api/                    # APIエンドポイント
│   │   ├── models/                 # データモデル
│   │   ├── services/               # ビジネスロジック
│   │   ├── middleware/             # ミドルウェア
│   │   ├── utils/                  # ユーティリティ
│   │   └── config/                 # 設定ファイル
│   ├── tests/                      # テストコード
│   └── package.json
├── frontend-guest/                 # 一般利用者向けフロントエンド
│   ├── src/
│   │   ├── components/             # コンポーネント
│   │   ├── pages/                  # ページ
│   │   ├── hooks/                  # カスタムフック
│   │   ├── contexts/               # コンテキスト
│   │   ├── utils/                  # ユーティリティ
│   │   └── api/                    # API呼び出し
│   ├── public/                     # 静的ファイル
│   └── package.json
├── frontend-owner/                 # 施設オーナー向けフロントエンド
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   ├── hooks/
│   │   ├── contexts/
│   │   ├── utils/
│   │   └── api/
│   ├── public/
│   └── package.json
├── frontend-admin/                 # 管理者向けフロントエンド
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   ├── hooks/
│   │   ├── contexts/
│   │   ├── utils/
│   │   └── api/
│   ├── public/
│   └── package.json
├── database/                       # データベース関連
│   ├── migrations/                 # マイグレーションファイル
│   ├── seeds/                      # シードデータ
│   └── schema.sql                  # スキーマ定義
└── README.md
```

## 実装状況

### ✅ 実装済み機能

#### バックエンド（全32エンドポイント）
- **認証API**: 一般利用者登録、オーナー登録（招待制）、ログイン、プロフィール管理、パスワード変更
- **物件管理API**: 物件CRUD、公開/非公開管理、オーナー専用一覧
- **部屋管理API**: 部屋CRUD、ステータス管理
- **予約管理API**: 予約CRUD、キャンセル、ステータス更新
- **招待管理API**: 招待CRUD、トークン検証（管理者専用）

#### フロントエンド
- **Guest（一般利用者向け）**: 11ページ実装（ログイン、登録、物件検索・詳細、予約、プロフィール管理）
- **Owner（施設オーナー向け）**: 13ページ実装（ログイン、招待登録、物件・部屋・予約管理、プロフィール管理）
- **Admin（管理者向け）**: 4ページ実装（ログイン、ダッシュボード、招待管理）

#### データベース
- 10テーブル実装済み（users, guest_profiles, owner_profiles, properties, rooms, property_images, room_images, property_amenities, bookings, invitations）
- UUIDを主キーとして使用
- Prisma ORMによる型安全なデータアクセス

#### セキュリティ
- JWT認証・認可
- bcryptによるパスワードハッシュ化（コスト係数12）
- express-validatorによる入力バリデーション
- ロール別アクセス制御（GUEST/OWNER/ADMIN）
- 招待トークンシステム（32バイトランダム生成、有効期限管理）

### 🚧 未実装機能

- 画像アップロード機能
- レビュー・評価機能
- 通知機能
- 空室検索・フィルタリング（高度な検索）
- オーナー向け分析・統計機能
- メール通知
- 決済機能

## 認証・認可の仕組み

### アカウント種別

1. **一般利用者 (Guest)** ✅ 実装済み
   - メールアドレス＋パスワードで新規登録
   - 施設の検索・予約が可能
   - プロフィール管理、パスワード変更機能あり

2. **施設オーナー (Owner)** ✅ 実装済み
   - 管理者からの招待トークン必須でアカウント作成
   - 自社施設・部屋の登録・編集・削除が可能
   - 予約の確認・ステータス管理が可能
   - プロフィール管理、パスワード変更機能あり

3. **管理者 (Admin)** ✅ 実装済み
   - 初期管理者アカウントは手動作成
   - 追加の管理者は既存管理者が招待
   - オーナー・管理者への招待作成・管理が可能
   - プラットフォーム全体の管理が可能（将来拡張予定）

### 権限管理

| 機能 | 一般利用者 | 施設オーナー | 管理者 |
|------|-----------|-------------|--------|
| 施設検索・閲覧 | ○ | ○ | ○ |
| 施設予約 | ○ | - | - |
| 予約履歴確認 | ○（自分のみ） | - | ○（全て） |
| 施設登録・編集 | - | ○（自社のみ） | ○（全て） |
| 予約管理 | - | ○（自社のみ） | ○（全て） |
| ユーザー管理 | - | - | ○ |
| オーナー管理 | - | - | ○ |
| システム設定 | - | - | ○ |

## 開発方針

### テスト駆動開発 (TDD)

1. 期待される入出力に基づき、まずテストを作成
2. テストを実行し、失敗を確認
3. テストが正しいことを確認できた段階でコミット
4. テストをパスさせる実装を進める
5. すべてのテストが通過するまで繰り返す

### コードの品質

- TypeScriptによる型安全性の確保
- ESLint/Prettierによるコード規約の統一
- 日本語コメントの記載
- 適切なエラーハンドリング

## クイックスタート

### 1. すべてのサーバーを一括起動（推奨）

```bash
# Makefileを使用
make start

# または直接スクリプトを実行
./start-all.sh
```

これにより、tmuxセッション内で以下がすべて起動します：
- バックエンドAPI (ポート 3100)
- Guest フロントエンド (ポート 3101)
- Owner フロントエンド (ポート 3102)
- Admin フロントエンド (ポート 3103)
- Prisma Studio (ポート 5555)

### 2. サーバー操作

```bash
# 起動状況の確認
make status

# すべて停止
make stop

# 再起動
make restart

# tmuxセッションにアタッチ（ログ確認）
tmux attach -t booking-service
```

### 3. 個別起動（手動）

別々のターミナルウィンドウで実行：

```bash
# バックエンド
make backend
# または: cd backend && npm run dev

# Guest
make guest
# または: cd frontend/guest && npm run dev

# Owner
make owner
# または: cd frontend/owner && npm run dev

# Admin
make admin
# または: cd frontend/admin && npm run dev
```

### 4. その他の便利なコマンド

```bash
# すべての依存関係をインストール
make install

# すべてをビルド
make build

# テスト実行
make test

# データベースマイグレーション
make db-migrate

# データベースリセット
make db-reset

# Prisma Studio起動
make db-studio

# ヘルプ表示
make help
```

## アクセスURL

- バックエンドAPI: http://localhost:3100/api/v1
- Guest フロントエンド: http://localhost:3101
- Owner フロントエンド: http://localhost:3102
- Admin フロントエンド: http://localhost:3103
- Prisma Studio: http://localhost:5555

## テストアカウント

開発・テスト用のアカウントが用意されています。以下の認証情報でログインできます。

### Admin（管理者）

- **URL**: http://localhost:3103
- **メールアドレス**: `admin@example.com`
- **パスワード**: `Admin123!`
- **権限**: オーナー・管理者への招待作成、プラットフォーム全体の管理

### Guest（一般利用者）

- **URL**: http://localhost:3101
- **メールアドレス**: `guest@example.com`
- **パスワード**: `Guest123!`
- **権限**: 施設検索・予約・レビュー投稿
- **プロフィール情報**:
  - 氏名: テスト ゲスト
  - 電話: 090-1234-5678

### Owner（施設オーナー）

- **URL**: http://localhost:3102
- **メールアドレス**: `owner-test@example.com`
- **パスワード**: `Owner123!`
- **権限**: 施設管理・予約管理・分析
- **プロフィール情報**:
  - 会社名: テスト宿泊施設株式会社
  - 事業許可番号: TEST-LICENSE-12345
  - 電話: 03-1234-5678
  - 住所: 東京都渋谷区渋谷1-1-1

### テストアカウントの作成・リセット

テストアカウントを再作成したい場合：

```bash
make db-seed
```

このコマンドで、上記の認証情報でテストアカウントを作成（または既存アカウントのパスワードをリセット）できます。

## 次のステップ

詳細な設計ドキュメントは `docs/` ディレクトリを参照してください。

1. [アーキテクチャ設計](docs/architecture/system-design.md)
2. [データベース設計](docs/database/schema-design.md)
3. [API仕様](docs/api/api-specification.md)
4. [技術スタック](docs/architecture/tech-stack.md)
5. [開発フェーズ](docs/architecture/development-phases.md)

# 開発フェーズとマイルストーン

## 概要

民泊・ゲストハウス予約サービスの開発を段階的に進めるためのフェーズ定義。

**最終更新**: 2025年11月16日
**現在の状況**: フェーズ0-1完了、フェーズ2-3も大部分実装済み

---

## フェーズ0: プロジェクトセットアップ（1週間）✅ 完了

### 目標
開発環境の構築と基盤整備。

### タスク

#### バックエンド
- [x] プロジェクト設計書作成
- [x] Node.js + Express プロジェクト初期化
- [x] TypeScript設定
- [x] ESLint + Prettier設定
- [x] PostgreSQL環境構築（ローカル開発用、Docker Compose）
- [x] Prismaセットアップ
- [x] 基本的なディレクトリ構造作成
- [x] 環境変数管理（.env）
- [x] Gitリポジトリ初期化、.gitignore設定

#### フロントエンド（3つ）
- [x] Next.js 14プロジェクト初期化（guest/owner/admin）
- [x] TypeScript設定
- [x] Tailwind CSS設定
- [x] ESLint + Prettier設定
- [x] 共通ディレクトリ構造作成
- [x] 環境変数管理

#### インフラ
- [ ] GitHubリポジトリ作成（ユーザー側で実施予定）
- [ ] GitHub Actions基本設定
- [ ] Railway/Renderアカウント作成
- [ ] Vercelプロジェクト作成
- [ ] Cloudinaryアカウント作成

### 成果物
- ✅ 各プロジェクトの初期セットアップ完了
- ✅ README.md、設計ドキュメント完備
- ⏳ CI/CDパイプライン（未設定）

---

## フェーズ1: 認証・ユーザー管理（2週間）✅ 完了

### 目標
ユーザー登録・ログイン機能の実装。

### タスク

#### バックエンド
- [x] Prismaスキーマ定義（users, guest_profiles, owner_profiles, invitations）
- [x] マイグレーション実行
- [x] 認証ミドルウェア実装（JWT）
- [x] パスワードハッシュ化（bcrypt、コスト係数12）
- [x] ユーザー登録API（一般利用者）
- [x] ログインAPI
- [x] ログアウトAPI
- [ ] トークンリフレッシュAPI（未実装、JWT有効期限24h固定）
- [x] プロフィール取得・更新API
- [x] パスワード変更API
- [x] 招待機能API（管理者のみ、CRUD + トークン検証）
- [x] オーナー登録API（招待トークン必須）
- [x] バリデーション実装（express-validator）
- [x] エラーハンドリング（統一エラーハンドラー）
- [x] テスト作成（auth.controller.test.ts のみ）

#### フロントエンド（一般利用者向け）
- [x] ログインページ
- [x] 新規登録ページ
- [x] プロフィールページ（表示・編集）
- [x] パスワード変更ページ
- [x] 認証コンテキスト実装（Zustand）
- [x] APIクライアント実装（Axios、26メソッド）
- [x] フォームバリデーション（クライアントサイド）
- [x] 認証状態の永続化（localStorage）
- [x] プライベートルート保護

#### フロントエンド（オーナー向け）
- [x] ログインページ
- [x] 招待トークンでの登録ページ（トークン検証機能付き）
- [x] プロフィールページ（オーナー向けフィールド）
- [x] パスワード変更ページ
- [x] 認証実装（Zustand）

#### フロントエンド（管理者向け）
- [x] ログインページ
- [x] オーナー招待ページ（招待作成・一覧・削除、URLコピー機能）
- [x] 招待一覧ページ（ステータスフィルター付き）
- [x] 認証実装（Zustand）

### 成果物
- ✅ ユーザー登録・ログイン機能
- ✅ 招待システム（32バイトトークン、有効期限管理）
- ✅ 認証済みユーザーのみアクセス可能なページ
- ✅ プロフィール管理機能
- ✅ パスワード変更機能

### テスト
- [x] 一部単体テスト（auth.controller.test.ts）
- [ ] 新規登録フロー（E2E、未実装）
- [ ] ログインフロー（E2E、未実装）
- [ ] トークン期限切れ時の動作（未実装）
- [ ] 招待フロー（E2E、未実装）

---

## フェーズ2: 施設管理（3週間）🟡 大部分完了

### 目標
施設の登録・編集・閲覧機能の実装。

### タスク

#### バックエンド
- [x] Prismaスキーマ定義（properties, rooms, property_images, room_images, property_amenities）
- [x] マイグレーション実行
- [ ] アメニティマスタデータ投入（未実装）
- [x] 施設登録API
- [x] 施設一覧取得API（公開中のみ）
- [x] オーナーの施設一覧取得API
- [x] 施設詳細取得API
- [x] 施設更新API
- [x] 施設削除API
- [x] 部屋登録API
- [x] 部屋一覧取得API
- [x] 部屋詳細取得API
- [x] 部屋更新API
- [x] 部屋削除API
- [ ] 画像アップロードAPI（未実装、Cloudinary連携予定）
- [ ] 画像削除API（未実装）
- [ ] アメニティ一覧取得API（未実装）
- [ ] 検索・フィルタリング機能（簡易版のみ）
- [ ] ソート機能（未実装）
- [ ] ページネーション（未実装）
- [ ] 施設承認API（未実装、管理者のみ）
- [ ] テスト作成（未実装）

#### フロントエンド（一般利用者向け）
- [x] ランディングページ
- [x] 施設一覧ページ（基本機能）
- [x] 施設詳細ページ
- [ ] 検索バー実装（未実装）
- [ ] フィルタリング機能（未実装）
- [ ] ソート機能（未実装）
- [ ] 画像ギャラリー（未実装）
- [ ] 地図表示（未実装、React Leaflet）
- [ ] ページネーション（未実装）

#### フロントエンド（オーナー向け）
- [x] ダッシュボード（施設一覧、ステータスフィルタ付き）
- [x] 施設登録ページ
- [x] 施設編集ページ（一部、物件詳細ページ）
- [x] 部屋編集ページ
- [ ] 画像アップロード機能（未実装）
- [ ] 画像管理（未実装、並び替え、削除）
- [ ] アメニティ選択UI（未実装）
- [ ] 住所入力（未実装、緯度経度取得）
- [ ] プレビュー機能（未実装）

#### フロントエンド（管理者向け）
- [ ] 全施設一覧ページ（未実装）
- [ ] 審査待ち施設一覧ページ（未実装）
- [ ] 施設詳細・審査ページ（未実装）
- [ ] 承認・却下機能（未実装）

### 成果物
- ✅ 施設の登録・編集・削除機能（基本機能）
- ✅ 部屋の登録・編集・削除機能
- ✅ 施設ステータス管理（DRAFT/PUBLISHED/SUSPENDED/CLOSED）
- 🚧 施設の検索・フィルタリング（簡易版のみ）
- ❌ 画像アップロード機能（未実装）
- ❌ 管理者による施設審査機能（未実装）

### テスト
- [ ] 施設登録フロー（E2E、未実装）
- [ ] 施設検索・フィルタリング（E2E、未実装）
- [ ] 画像アップロード（E2E、未実装）
- [ ] 施設承認フロー（E2E、未実装）

---

## フェーズ3: 予約管理（3週間）🟡 大部分完了

### 目標
予約機能の実装。

### タスク

#### バックエンド
- [x] Prismaスキーマ定義（bookings）
- [x] マイグレーション実行
- [ ] 空き枠取得API（未実装、availability テーブル未使用）
- [ ] 空き枠更新API（未実装、オーナーのみ）
- [x] 予約作成API（基本機能、重複チェックなし）
- [x] 予約一覧取得API（自分の予約、ゲスト用）
- [x] オーナーの予約一覧取得API
- [x] 予約詳細取得API
- [x] 予約ステータス更新API（オーナー/管理者のみ）
- [x] 予約キャンセルAPI
- [x] 料金計算ロジック（簡易版、宿泊日数×単価のみ）
- [ ] トランザクション処理（未実装）
- [ ] テスト作成（未実装）

#### フロントエンド（一般利用者向け）
- [x] 予約一覧ページ
- [x] 予約詳細ページ
- [x] 予約キャンセル機能
- [ ] 施設詳細ページに予約フォーム追加（未実装）
- [ ] 日付選択カレンダー（未実装、空き状況表示）
- [ ] 宿泊人数選択（未実装）
- [ ] 料金計算表示
- [ ] 予約確認ページ
- [ ] 予約完了ページ
- [ ] 予約一覧ページ
- [ ] 予約詳細ページ
- [ ] 予約キャンセル機能

#### フロントエンド（オーナー向け）
- [ ] ダッシュボードに予約サマリー追加
- [ ] 空き枠管理ページ（カレンダー形式）
- [ ] 一括空き枠設定機能
- [ ] 特別料金設定機能
- [ ] 予約一覧ページ（自分の施設の予約）
- [ ] 予約詳細ページ
- [ ] 予約承認・拒否機能
- [ ] ゲスト情報表示

#### フロントエンド（管理者向け）
- [ ] 全予約一覧ページ
- [ ] 予約詳細ページ
- [ ] 問題のある予約の対応

### 成果物
- 予約作成機能
- 空き枠管理機能
- 予約一覧・詳細表示
- 予約のキャンセル機能
- オーナーによる予約管理

### テスト
- [ ] 予約作成フロー（E2E）
- [ ] 空き枠設定（E2E）
- [ ] 予約キャンセル（E2E）
- [ ] 重複予約の防止（単体テスト）
- [ ] 料金計算の正確性（単体テスト）

---

## フェーズ4: レビュー機能（2週間）

### 目標
レビュー投稿・表示機能の実装。

### タスク

#### バックエンド
- [ ] Prismaスキーマ定義（reviews）
- [ ] マイグレーション実行
- [ ] レビュー投稿API（予約完了者のみ）
- [ ] レビュー一覧取得API
- [ ] レビュー詳細取得API
- [ ] オーナー返信API
- [ ] レビュー統計計算（平均評価、分布）
- [ ] バリデーション（1予約1レビュー）
- [ ] テスト作成

#### フロントエンド（一般利用者向け）
- [ ] 施設詳細ページにレビュー表示
- [ ] レビュー統計表示（平均評価、星の分布）
- [ ] レビュー投稿フォーム
- [ ] 評価項目（総合、清潔さ、正確性、立地、コスパ）
- [ ] レビュー投稿完了ページ

#### フロントエンド（オーナー向け）
- [ ] レビュー一覧ページ
- [ ] レビュー詳細ページ
- [ ] オーナー返信機能
- [ ] レビュー統計表示

#### フロントエンド（管理者向け）
- [ ] 不適切なレビューの管理（将来機能）

### 成果物
- レビュー投稿機能
- レビュー表示機能
- オーナー返信機能
- 評価統計表示

### テスト
- [ ] レビュー投稿フロー（E2E）
- [ ] オーナー返信フロー（E2E）
- [ ] 1予約1レビューの制約（単体テスト）

---

## フェーズ5: 通知機能（1週間）

### 目標
通知機能の実装。

### タスク

#### バックエンド
- [ ] Prismaスキーマ定義（notifications）
- [ ] マイグレーション実行
- [ ] 通知作成ユーティリティ
- [ ] 通知一覧取得API
- [ ] 通知既読API
- [ ] 全通知既読API
- [ ] 予約作成時の通知
- [ ] 予約承認時の通知
- [ ] レビュー投稿時の通知
- [ ] メール通知（nodemailer）
- [ ] テスト作成

#### フロントエンド（全アプリ共通）
- [ ] ヘッダーに通知アイコン
- [ ] 通知バッジ（未読数）
- [ ] 通知ドロップダウン
- [ ] 通知一覧ページ
- [ ] 既読機能
- [ ] リアルタイム通知（将来: WebSocket）

### 成果物
- 通知機能
- メール通知
- 通知一覧・既読機能

### テスト
- [ ] 通知作成（単体テスト）
- [ ] メール送信（単体テスト）

---

## フェーズ6: 管理者機能強化（1週間）

### 目標
管理者向けの統計・分析機能の実装。

### タスク

#### バックエンド
- [ ] 統計API（ユーザー数、施設数、予約数、売上）
- [ ] ユーザー一覧取得API
- [ ] ユーザーステータス更新API
- [ ] 全施設一覧取得API
- [ ] システムログ取得API
- [ ] テスト作成

#### フロントエンド（管理者向け）
- [ ] ダッシュボード強化（KPI表示）
- [ ] ユーザー管理ページ
- [ ] ユーザー検索・フィルタリング
- [ ] ユーザーステータス変更
- [ ] 統計・分析ページ
- [ ] 売上推移グラフ
- [ ] ユーザー増加グラフ
- [ ] 施設数推移グラフ
- [ ] システムログページ

### 成果物
- 管理者ダッシュボード
- ユーザー管理機能
- 統計・分析機能

### テスト
- [ ] ユーザー管理フロー（E2E）
- [ ] 統計データの正確性（単体テスト）

---

## フェーズ7: オーナー分析機能（1週間）

### 目標
オーナー向けの分析機能の実装。

### タスク

#### バックエンド
- [ ] オーナー統計API（売上、予約数、稼働率）
- [ ] 時系列データ取得API
- [ ] テスト作成

#### フロントエンド（オーナー向け）
- [ ] ダッシュボード強化
- [ ] 売上推移グラフ
- [ ] 予約数推移グラフ
- [ ] 稼働率表示
- [ ] レビュー評価推移
- [ ] 月次レポート

### 成果物
- オーナーダッシュボード
- 売上・予約分析機能

### テスト
- [ ] グラフ表示（E2E）
- [ ] データの正確性（単体テスト）

---

## フェーズ8: UI/UX改善・最適化（2週間）

### 目標
ユーザー体験の向上とパフォーマンス最適化。

### タスク

#### フロントエンド（全アプリ）
- [ ] ローディング状態の改善
- [ ] エラー表示の改善
- [ ] アニメーション追加（framer-motion）
- [ ] トースト通知（react-hot-toast）
- [ ] スケルトンローダー
- [ ] 画像遅延読み込み
- [ ] ページ遷移の高速化
- [ ] レスポンシブデザインの微調整
- [ ] アクセシビリティ改善

#### バックエンド
- [ ] APIレスポンスの最適化
- [ ] データベースクエリの最適化
- [ ] インデックス追加
- [ ] キャッシュ戦略（Redis検討）
- [ ] レート制限の実装

### 成果物
- スムーズなUI/UX
- パフォーマンス改善
- アクセシビリティ向上

### テスト
- [ ] パフォーマンステスト
- [ ] Lighthouse監査

---

## フェーズ9: セキュリティ強化（1週間）

### 目標
セキュリティの強化。

### タスク

#### バックエンド
- [ ] CSRF対策強化
- [ ] レート制限強化
- [ ] SQLインジェクション対策確認
- [ ] XSS対策確認
- [ ] セキュリティヘッダー設定（helmet）
- [ ] 入力バリデーション強化
- [ ] パスワードポリシー強化
- [ ] セッション管理強化

#### フロントエンド
- [ ] CSP設定
- [ ] 機密情報のローカルストレージ禁止確認
- [ ] 入力サニタイズ

#### インフラ
- [ ] HTTPS強制
- [ ] 環境変数の適切な管理
- [ ] バックアップ設定
- [ ] セキュリティ監査

### 成果物
- セキュリティ強化されたアプリケーション
- セキュリティチェックリスト

### テスト
- [ ] セキュリティテスト
- [ ] ペネトレーションテスト（簡易）

---

## フェーズ10: テスト・デバッグ（2週間）

### 目標
包括的なテストとバグ修正。

### タスク

#### テスト
- [ ] 単体テストのカバレッジ向上（目標: 80%以上）
- [ ] E2Eテストの拡充
- [ ] エッジケースのテスト
- [ ] クロスブラウザテスト
- [ ] モバイルデバイステスト
- [ ] 負荷テスト（簡易）

#### バグ修正
- [ ] バグの洗い出し
- [ ] 優先度付け
- [ ] 修正実施
- [ ] 回帰テスト

#### ドキュメント
- [ ] APIドキュメント更新
- [ ] README更新
- [ ] 運用マニュアル作成
- [ ] トラブルシューティングガイド作成

### 成果物
- 安定したアプリケーション
- 充実したドキュメント

---

## フェーズ11: デプロイ準備（1週間）

### 目標
本番環境へのデプロイ準備。

### タスク

#### インフラ
- [ ] 本番環境のデータベース構築
- [ ] 本番環境への環境変数設定
- [ ] Cloudinary本番環境設定
- [ ] Sentry本番環境設定
- [ ] ドメイン設定
- [ ] SSL証明書設定

#### データ
- [ ] マスタデータ投入（アメニティなど）
- [ ] 初期管理者アカウント作成
- [ ] サンプルデータ作成（デモ用）

#### モニタリング
- [ ] Sentryエラートラッキング設定
- [ ] ログ監視設定
- [ ] アラート設定

#### CI/CD
- [ ] 本番デプロイパイプライン構築
- [ ] ステージング環境でのテスト
- [ ] ロールバック手順確認

### 成果物
- 本番環境の構築
- デプロイパイプライン

---

## フェーズ12: リリース・運用開始（1週間）

### 目標
本番リリースと初期運用。

### タスク

#### リリース
- [ ] 本番環境へのデプロイ
- [ ] 動作確認
- [ ] パフォーマンス確認
- [ ] セキュリティ確認

#### 運用
- [ ] エラー監視
- [ ] ユーザーフィードバック収集
- [ ] 緊急バグ対応
- [ ] パフォーマンスチューニング

#### マーケティング（必要に応じて）
- [ ] リリースアナウンス
- [ ] ドキュメントサイト公開
- [ ] デモサイト公開

### 成果物
- 本番稼働中のサービス
- 運用体制の確立

---

## 今後の拡張機能（フェーズ13以降）

### 優先度: 高
- [ ] Google連携認証
- [ ] 決済機能（Stripe）
- [ ] カレンダー連携（iCal）
- [ ] メッセージング機能（ゲスト↔オーナー）
- [ ] お気に入り機能
- [ ] リアルタイム通知（WebSocket）

### 優先度: 中
- [ ] 多言語対応（i18n）
- [ ] モバイルアプリ（React Native）
- [ ] クーポン・割引機能
- [ ] ポイント制度
- [ ] レコメンド機能（AIベース）
- [ ] チャットボット（カスタマーサポート）

### 優先度: 低
- [ ] ブログ機能
- [ ] アフィリエイトプログラム
- [ ] APIの一般公開
- [ ] サードパーティ連携（Airbnb、Booking.com同期）

---

## マイルストーン

| マイルストーン | 完了予定 | 主要機能 |
|-------------|----------|---------|
| **M1: プロトタイプ** | フェーズ3終了時 | 認証、施設管理、予約機能 |
| **M2: ベータ版** | フェーズ7終了時 | レビュー、通知、分析機能 |
| **M3: リリース候補** | フェーズ10終了時 | 全機能実装、テスト完了 |
| **M4: 正式リリース** | フェーズ12終了時 | 本番稼働開始 |

---

## 開発スケジュール（概算）

- **フェーズ0**: 1週間
- **フェーズ1**: 2週間
- **フェーズ2**: 3週間
- **フェーズ3**: 3週間
- **フェーズ4**: 2週間
- **フェーズ5**: 1週間
- **フェーズ6**: 1週間
- **フェーズ7**: 1週間
- **フェーズ8**: 2週間
- **フェーズ9**: 1週間
- **フェーズ10**: 2週間
- **フェーズ11**: 1週間
- **フェーズ12**: 1週間

**合計: 約21週間（約5ヶ月）**

※実際の開発スピードやリソースにより変動します。

---

## 開発の進め方

### アジャイル開発
- 2週間スプリント
- 毎スプリント終了時にデモ
- レトロスペクティブでプロセス改善

### タスク管理
- GitHub Issuesでタスク管理
- Project Boardでカンバン管理
- Pull Requestでコードレビュー

### ブランチ戦略
- `main`: 本番環境
- `develop`: 開発環境
- `feature/*`: 機能開発
- `hotfix/*`: 緊急修正

### コミット規約
```
<type>(<scope>): <subject>

feat: 新機能
fix: バグ修正
docs: ドキュメント
style: フォーマット
refactor: リファクタリング
test: テスト
chore: その他
```

---

## リスク管理

### 技術的リスク
- **データベース設計の変更**: 早期にスキーマを確定、マイグレーション管理を徹底
- **パフォーマンス問題**: 定期的な負荷テスト、早期の最適化
- **セキュリティ脆弱性**: セキュリティベストプラクティスの遵守、定期監査

### スケジュールリスク
- **機能追加の要望**: スコープクリープを防ぐため、フェーズごとに明確な目標設定
- **予期せぬバグ**: テストを充実させ、早期発見・早期修正
- **リソース不足**: 優先度付けを明確にし、必要に応じてスコープ調整

### 運用リスク
- **サーバーダウン**: 監視体制の構築、自動アラート設定
- **データ損失**: 定期バックアップ、リストア手順の確認
- **法的問題**: 利用規約、プライバシーポリシーの整備
